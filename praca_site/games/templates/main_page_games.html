{% extends 'layout.html' %}
{% load static %}

{% block title %}
    Gra Segregacja Śmieci
{% endblock %}

{% block content %}
<style>
    body {
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: sans-serif;
        flex-direction: column;
    }
    #startBtn {
        border-radius: 15px;
        width: 10vw;
        height: 5vh;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

  #startBtn:hover {
      border-radius: 15px;
      background-color: gray;
  }

#gameCanvas {
    border-radius: 15px;
    display: block;
    width: 80vw;
    height: 80vh;
    background: cornflowerblue; /* kolor tła */
}

</style>

<canvas id="gameCanvas"></canvas>
<button id="startBtn">Start</button>


<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const startBtn = document.getElementById("startBtn");

// Dopasowanie rozmiaru canvas do okna
function resizeCanvas() {
    canvas.width = window.innerWidth * 0.8;   // 80% szerokości ekranu
    canvas.height = window.innerHeight * 0.8; // 80% wysokości ekranu
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const bins = [
    { type: "plastic", img: new Image() },
    { type: "paper", img: new Image() },
    { type: "glass", img: new Image() },
    { type: "bio", img: new Image() },
    { type: "mixed", img: new Image() }

];

// Podaj ścieżki do obrazków
bins[0].img.src = "{% static 'images/bins/metale.png' %}";
bins[1].img.src = "{% static 'images/bins/metale.png' %}";
bins[2].img.src = "{% static 'images/bins/metale.png' %}";
bins[3].img.src = "{% static 'images/bins/metale.png' %}";
bins[4].img.src = "{% static 'images/bins/metale.png' %}";

function showBins() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const maxBinHeight = canvas.height * 0.3; // maksymalna wysokość kosza
    const availableWidth = canvas.width;
    const numBins = bins.length;

    // Najpierw przelicz skalę koszy, aby ich wysokość nie przekraczała maxBinHeight
    bins.forEach(bin => {
        const scale = maxBinHeight / bin.img.naturalHeight;
        bin.width = bin.img.naturalWidth * scale;
        bin.height = bin.img.naturalHeight * scale;
    });

    // Oblicz łączną szerokość koszy i skalę w poziomie, jeśli nie mieszczą się w całości
    const totalBinsWidth = bins.reduce((sum, bin) => sum + bin.width, 0);
    let horizontalScale = 1;
    if (totalBinsWidth > availableWidth) {
        horizontalScale = availableWidth / totalBinsWidth;
        bins.forEach(bin => {
            bin.width *= horizontalScale;
            bin.height *= horizontalScale;
        });
    }

    // Oblicz równy odstęp między koszami, aby wypełnić całą szerokość
    const totalWidthWithGaps = bins.reduce((sum, bin) => sum + bin.width, 0);
    const gap = (availableWidth - totalWidthWithGaps) / (numBins + 1);

    let currentX = gap;
    bins.forEach(bin => {
        bin.x = currentX;
        bin.y = canvas.height - bin.height - 20;
        ctx.drawImage(bin.img, bin.x, bin.y, bin.width, bin.height);
        currentX += bin.width + gap;
    });
}


// Poczekaj aż wszystkie obrazki się załadują
let loaded = 0;
bins.forEach(bin => {
    bin.img.onload = () => {
        loaded++;
        if (loaded === bins.length) {
            showBins(); // rysuj dopiero gdy wszystkie obrazki gotowe
        }
    }
});



/*
const binWidth = 100;
const binHeight = 40;
const binY = canvas.height - binHeight - 10;

let score = 0;
let lives = 3;
let gameRunning = false;

// Obiekt gracza — śmieć
let trash = spawnTrash();

function spawnTrash() {
  const types = ["plastic", "paper", "glass"];
  const type = types[Math.floor(Math.random() * types.length)];
  return {
    x: canvas.width / 2 - 15,
    y: 0,
    size: 30,
    speed: 3,
    type,
    color: typeColor(type)
  };
}

function typeColor(type) {
  if (type === "plastic") return "red";
  if (type === "paper") return "green";
  if (type === "glass") return "blue";
}

function drawBins() {
  bins.forEach(bin => {
    ctx.fillStyle = bin.color;
    ctx.fillRect(bin.x, binY, binWidth, binHeight);
    ctx.fillStyle = "#fff";
    ctx.font = "12px Arial";
    ctx.fillText(bin.type, bin.x + 20, binY + 25);
  });
}

function drawTrash() {
  ctx.fillStyle = trash.color;
  ctx.fillRect(trash.x, trash.y, trash.size, trash.size);
}

function moveTrash() {
  trash.y += trash.speed;

  // Jeśli śmieć dotrze do koszy
  if (trash.y + trash.size >= binY) {
    const bin = bins.find(b => trash.x + trash.size / 2 > b.x && trash.x + trash.size / 2 < b.x + binWidth);

    if (bin && bin.type === trash.type) {
      score++;
    } else {
      lives--; // traci życie, jeśli źle dopasowany
      if (lives <= 0) {
        endGame();
        return;
      }
    }
    trash = spawnTrash();
  }
}

function drawScore() {
  ctx.fillStyle = "#000";
  ctx.font = "20px Arial";
  ctx.fillText("Wynik: " + score, 10, 30);
}

function drawLives() {
  ctx.fillStyle = "black";
  ctx.font = "20px Arial";
  ctx.fillText("❤️: " + lives, canvas.width - 90, 30);
}

function gameLoop() {
  if (!gameRunning) return; // zatrzymanie gry, jeśli nie wystartowała
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBins();
  drawTrash();
  drawScore();
  drawLives();
  moveTrash();
  requestAnimationFrame(gameLoop);
}

function endGame() {
  gameRunning = false;
  ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "white";
  ctx.font = "30px Arial";
  ctx.fillText("Koniec gry!", canvas.width / 2 - 80, canvas.height / 2 - 20);
  ctx.font = "24px Arial";
  ctx.fillText("Wynik: " + score, canvas.width / 2 - 50, canvas.height / 2 + 20);

  // pokaż przycisk ponownie
  startBtn.textContent = "Zagraj ponownie";
  startBtn.style.display = "block";
}

document.addEventListener("keydown", (e) => {
  if (!gameRunning) return; // nie działa przed startem gry

  const trashCenter = trash.x + trash.size / 2;
  let currentBinIndex = bins.findIndex(
    b => trashCenter > b.x && trashCenter < b.x + binWidth
  );

  if (currentBinIndex === -1) currentBinIndex = 0;

  if (e.key === "ArrowLeft") {
    const newIndex = Math.max(0, currentBinIndex - 1);
    trash.x = bins[newIndex].x + binWidth / 2 - trash.size / 2;
  }

  if (e.key === "ArrowRight") {
    const newIndex = Math.min(bins.length - 1, currentBinIndex + 1);
    trash.x = bins[newIndex].x + binWidth / 2 - trash.size / 2;
  }
});

startBtn.addEventListener("click", () => {
  score = 0;
  lives = 3;
  trash = spawnTrash();
  gameRunning = true;
  startBtn.style.display = "none";
  gameLoop();
});
*/

</script>
{% endblock %}
